*,
*::before,
*::after {
  box-sizing: border-box;
}

.container {
  color: #d7dde8;
  display: flex;
  flex-direction: column;
  justify-items: center;
  align-items: center;
  position: relative;
}

.hint {
  position: absolute;
  top: 60%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: clamp(14px, 2vw, 18px);
}

/* Fan area */
.fan {
  position: relative;
  width: 80vw;
  height: 60vh;
  overflow: visible;
  perspective: 1000px;

  display: flex;
  justify-content: center;
  align-items: center;
}
.idle,
.shuffle {
  display: block;
  .anchor {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  .card {
    transform: rotate(0deg);
  }
}

.stack {
  display: block;
  .anchor {
    position: absolute;
    top: 30%; /* same as your .spread anchor */
    left: 50%;
    transform: translate(-50%, -50%);
  }
  .card {
    transform: rotate(var(--left-angle)); /* same rotation/pivot as leftmost spread card */
  }
}

.spread {
  display: block;
  .anchor {
    position: absolute;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  .card {
    transform: rotate(0deg);
  }
}

.weave,
.triple {
  .anchor {
    position: relative;
    top: auto;
    left: auto;
    transform: none;
  }
}

.anchor {
  position: relative;
  width: 0;
  height: 0;
}
.slot {
  position: absolute;
  bottom: 0;
  left: 0;
}

/* card */
.card {
  position: absolute;
  left: calc(var(--card-w) * -0.5);
  bottom: 0;
  width: var(--card-w);
  height: var(--card-h);
  border-radius: 4px;
  overflow: hidden;

  transform-origin: 50% calc(100% + var(--pivot, 260px));
  transform: rotate(0deg);
  transition: transform 560ms cubic-bezier(0.2, 0.7, 0.2, 1), box-shadow 240ms ease,
    filter 240ms ease;

  img {
    width: 100%;
    height: 100%;
    display: block;
    border-radius: inherit;
    pointer-events: none;
  }
}

/* ---------- ATTENTION FOR TOP CARD (idle) ---------- */

/* Respect prefers-reduced-motion */
@media (prefers-reduced-motion: reduce) {
  .attention,
  .starterHint {
    animation: none !important;
    transition: none !important;
  }
}

button {
  border: 0;
  padding: 0;
  margin: 0;
}

/* Click-to-start overlay aligned with deck footprint */
.starterOverlay {
  position: absolute;
  bottom: 0;
  left: calc(var(--card-w) * -0.5); /* align to deck */
  width: var(--card-w);
  height: var(--card-h);
  border-radius: 14px;
  background: transparent;
  z-index: 3;
  display: grid;
  place-items: center center; /* place hint near baseline */
  cursor: pointer;
  outline: none;
}

.starterHint {
  margin-bottom: 10px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 16px;
  font-weight: bold;
  z-index: 4;
  background: linear-gradient(
    270deg,
    #ff00ff,
    #ff0000,
    #ff7a00,
    #ffee00,
    #00ff00,
    #00ffff,
    #0066ff,
    #ff00ff
  );
  background-size: 400% 400%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 0 0 6px #fff;
  /* Animate the rainbow sweep */
  animation: rainbowFlow 5s linear infinite;
}

@keyframes rainbowFlow {
  0% {
    background-position: 0% 50%;
  }
  100% {
    background-position: 100% 50%;
  }
}

/* Attention styling applied to the top card while idle */
.attention {
  /* subtle idle tilt + float */
  animation: idleNudge 2200ms ease-in-out infinite;
  transform-origin: 50% 90%;
  position: relative;

  /* soft pulse halo behind the card */
  &::before {
    content: "";
    position: absolute;
    inset: -8px;
    border-radius: 14px;
    background: radial-gradient(
      ellipse at center,
      rgba(255, 255, 255, 0.18),
      rgba(255, 255, 255, 0) 60%
    );
    filter: blur(4px);
    animation: pulse 1800ms ease-out infinite;
    z-index: -1;
  }

  /* gentle sheen passing diagonally over the card */
  &::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0) 35%,
      rgba(255, 255, 255, 0.18) 50%,
      rgba(255, 255, 255, 0) 65%
    );
    transform: translateX(-120%);
    animation: sheen 2600ms ease-in-out infinite 400ms;
    pointer-events: none;
  }
}

@keyframes idleNudge {
  0% {
    transform: rotate(-0.6deg) translateY(0);
  }
  50% {
    transform: rotate(0.6deg) translateY(-2px);
  }
  100% {
    transform: rotate(-0.6deg) translateY(0);
  }
}

@keyframes pulse {
  0% {
    opacity: 0;
    transform: scale(0.96);
  }
  30% {
    opacity: 0.5;
    transform: scale(1);
  }
  100% {
    opacity: 0;
    transform: scale(1.06);
  }
}

@keyframes sheen {
  0% {
    transform: translateX(-120%) rotate(0.001deg);
    opacity: 0;
  }
  35% {
    opacity: 0.6;
  }
  65% {
    opacity: 0.6;
  }
  100% {
    transform: translateX(120%) rotate(0.001deg);
    opacity: 0;
  }
}

/* ---------- PHASE ANIMATIONS ---------- */

/* 1) chaos shuffle in the center */
.shuffle .card {
  animation: chaos var(--cdur) cubic-bezier(0.2, 0.7, 0.2, 1) var(--cdelay) both;
}
@keyframes chaos {
  0% {
    transform: translate(0, 0) rotate(0deg);
  }
  35% {
    transform: translate(var(--cx), var(--cy)) rotate(var(--crot));
  }
  70% {
    transform: translate(calc(var(--cx) * -0.6), calc(var(--cy) * -0.6))
      rotate(calc(var(--crot) * -0.45));
  }
  100% {
    transform: translate(0, 0) rotate(0deg);
  }
}

/* 2) WEAVE (vertical up/down with 1–3 rhythm), repeated N passes (handled in TS) */
.weave .card {
  --amp: 52px; /* stronger motion for visibility */
  --phaseDelay: calc((var(--weaveCluster) - 1) * 110ms);
  animation: weaveUpDown var(--weave-dur) ease-in-out calc(var(--delay) + var(--phaseDelay)) both;
}
@keyframes weaveUpDown {
  0% {
    transform: rotate(0deg);
  }
  20% {
    transform: translateY(calc((var(--pile) - 0.5) * -2 * var(--amp))) rotate(0deg);
  }
  50% {
    transform: translateY(0) rotate(0deg);
  }
  75% {
    transform: translateY(calc((var(--pile) - 0.5) * 2 * var(--amp))) rotate(0deg);
  }
  100% {
    transform: rotate(0deg);
  }
}

/* 3) triple — 3 piles longer, then middle→left, then (left+middle)→right ON TOP */
.triple .card {
  /* horizontal pile positions */
  --triLeftX: -120px;
  --triMidX: 0px;
  --triRightX: 120px;

  /* depth & lift */
  --liftY: 28px;
  --zLift: 90px; /* ↑ slightly stronger lift */

  --j: var(--stackJitter, 0px);

  /* ensure left+middle (tri0/tri1) are above right (tri2) during triple */
  z-index: calc(var(--isTri0) * 3000 + var(--isTri1) * 2000 + var(--isTri2) * 1000 + var(--i));

  animation: tripleStacks var(--triple-dur) cubic-bezier(0.2, 0.7, 0.2, 1) var(--delay) both;
}

@keyframes tripleStacks {
  0% {
    transform: rotate(0deg) translateZ(0);
  }

  /* PHASE A — show 3 piles longer (until 35%) */
  35% {
    transform: translateX(
        calc(
          var(--isTri0) * var(--triLeftX) + var(--isTri1) * var(--triMidX) + var(--isTri2) *
            var(--triRightX)
        )
      )
      translateY(calc((var(--isTri0) * -1 + var(--isTri1) * -0.5) * var(--liftY) - var(--j)))
      rotate(0deg) translateZ(0);
  }

  /* PHASE B — middle → left (35–65%) */
  65% {
    transform: translateX(
        calc((var(--isTri0) + var(--isTri1)) * var(--triLeftX) + var(--isTri2) * var(--triRightX))
      )
      translateY(calc((var(--isTri1)) * -1 * var(--liftY) - var(--j)))
      rotate(calc(var(--isTri1) * -4deg)) translateZ(calc(var(--isTri1) * var(--zLift)));
  }

  /* PHASE C — (left+middle) → right, ABOVE right pile */
  100% {
    transform: translateX(var(--triRightX))
      translateY(calc((var(--isTri0) + var(--isTri1)) * -0.6 * var(--liftY) - var(--j)))
      rotate(calc((var(--isTri0) + var(--isTri1)) * -3deg))
      translateZ(calc((var(--isTri0) + var(--isTri1)) * var(--zLift)));
  }
}

/* 4) STACK: collapse to -80° (still centered) */
.stack .card {
  transform: rotate(-80deg);
  transition-delay: 0ms;
}

/* 5) SPREAD: apply fan angles; hover only here */
.isOpen.spread .card {
  transform: rotate(var(--angle));
  transition-delay: var(--sweep, var(--delay, 0ms));

  &:hover,
  &:focus-visible {
    outline: none;
    transform: rotate(var(--angle)) translateY(-14px);
    cursor: pointer;
  }
}

/* Non-spread phases: cannot pick; no hover */
.fan:not(.isOpen) .card,
.fan:not(.spread) .card {
  pointer-events: none;
}

/* Dim picked in fan */
.isPicked {
  opacity: 0.45;
  filter: saturate(0.75);
}

.result {
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translate(-50%, 0);
}

/* Tip */
.tip {
  margin-top: 12px;
  text-align: center;
  color: #cbd5e1;
  opacity: 0.9;
}

/* Tray */
.trayWrap {
  margin-top: 16px;
  display: grid;
  gap: 12px;
  justify-items: center;
}
.tray {
  display: grid;
  grid-auto-flow: column;
  gap: clamp(12px, 3vw, 22px);
  align-items: start;
}
.trayItem {
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 10px;
  justify-items: center;
  align-items: center;
}

.badge {
  background: linear-gradient(90deg, rgba(59, 130, 246, 0.9), rgba(147, 51, 234, 0.9));
  color: #fff;
  padding: 4px 10px;
  border-radius: 999px;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
  font: 600 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

/* 3D flip cards in tray */
.trayCard {
  width: clamp(96px, calc(var(--card-w) * 0.9), var(--card-w));
  height: clamp(155px, calc(var(--card-h) * 0.9), var(--card-h));
  perspective: 1000px;
  transform-style: preserve-3d;
  border-radius: 14px;
  cursor: pointer;
}
.trayInner {
  position: relative;
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  transition: transform 560ms cubic-bezier(0.22, 0.7, 0.22, 1);
  border-radius: inherit;
  // box-shadow: var(--elev-1);
}
.back,
.front {
  position: absolute;
  inset: 0;
  backface-visibility: hidden;
  border-radius: inherit;
}
.back {
  transform: rotateY(0deg);
}
.front {
  transform: rotateY(180deg);
}
.img {
  width: 100%;
  object-fit: fill;
}
.flipped .trayInner {
  transform: rotateY(180deg);
}

.caption {
  width: min(260px, 42vw);
  text-align: center;
  color: #e7e7e7;
}
.cardName {
  font-weight: 700;
  letter-spacing: 0.3px;
  margin-bottom: 4px;
}
.meaning {
  opacity: 0.9;
}
.desc {
  opacity: 0.75;
}
.tapHint {
  opacity: 0.62;
  font-style: italic;
}

/* RWD */
@media (max-width: 640px) {
  .controls {
    flex-wrap: wrap;
    padding: 0 12px;
  }
  .badge {
    transform: scale(0.95);
    transform-origin: left top;
  }
  .tray {
    gap: 14px;
  }
}
